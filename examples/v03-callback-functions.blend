module Game.CallbackExample
import setRasterInterrupt, setTimerInterrupt, enableInterrupts from c64.interrupts
import setSpritePosition, setBackgroundColor from c64.vic

// Game state variables
var playerX: byte = 100
var playerY: byte = 100
var frameCounter: byte = 0
var currentAI: callback

// Hardware interrupt callbacks - called by VIC-II/CIA chips
callback function frameUpdate(): void
    frameCounter += 1
    setSpritePosition(0, playerX, playerY)

    // Color cycling effect
    if frameCounter > 50 then
        setBackgroundColor(RED)
    else
        if frameCounter > 25 then
            setBackgroundColor(GREEN)
        else
            setBackgroundColor(BLUE)
        end if
    end if

    if frameCounter >= 60 then
        frameCounter = 0
    end if
end function

callback function musicDriver(): void
    playNextMusicFrame()
    updateSIDRegisters()
end function

// AI behavior callbacks - called by game logic
callback function aggressiveAI(): void
    attackPlayer()
    moveTowardPlayer()
end function

callback function defensiveAI(): void
    evadePlayer()
    findCover()
end function

callback function patrolAI(): void
    followPatrolRoute()
    scanForPlayer()
end function

// Menu action callbacks - called by UI system
callback function startNewGame(): void
    resetPlayer()
    resetEnemies()
    currentState = PLAYING
end function

callback function loadSavedGame(): void
    loadPlayerData()
    loadWorldState()
    currentState = PLAYING
end function

export function main(): void
    initializeCallbacks()
    runGameLoop()
end function

function initializeCallbacks(): void
    // Setup hardware callbacks
    setRasterInterrupt(250, frameUpdate)    // Graphics at 60 FPS
    setTimerInterrupt(1000, musicDriver)    // Music at 1kHz

    // Setup AI callbacks
    var aiTypes: callback[3] = [aggressiveAI, defensiveAI, patrolAI]
    for i = 0 to enemyCount - 1
        var aiType: byte = random(3)
        setEnemyAI(i, aiTypes[aiType])      // Random AI assignment
    next i

    // Setup menu callbacks
    var menuActions: callback[2] = [startNewGame, loadSavedGame]
    setMenuActions(menuActions)

    enableInterrupts()
end function

function runGameLoop(): void
    while gameRunning
        // Main game logic runs independently
        handlePlayerInput()
        updateGameState()
        checkWinConditions()

        // Graphics and music handled by interrupt callbacks
        // AI and UI handled by assigned callbacks
    end while
end function

function handlePlayerInput(): void
    if joystickLeft() then
        if playerX > 24 then
            playerX -= 2
        end if
    end if

    if joystickRight() then
        if playerX < 320 then
            playerX += 2
        end if
    end if
end function

function updateGameState(): void
    // Game logic independent of graphics timing
    updateEnemies()
    checkCollisions()
    updateScore()
end function
